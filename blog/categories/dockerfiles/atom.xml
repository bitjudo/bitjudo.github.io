<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: dockerfiles | bitJudo]]></title>
  <link href="http://bitjudo.com/blog/categories/dockerfiles/atom.xml" rel="self"/>
  <link href="http://bitjudo.com/"/>
  <updated>2014-03-13T11:53:01-04:00</updated>
  <id>http://bitjudo.com/</id>
  <author>
    <name><![CDATA[a couple of geeks]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Building Efficient Dockerfiles - Node.js]]></title>
    <link href="http://bitjudo.com/blog/2014/03/13/building-efficient-dockerfiles-node-dot-js/"/>
    <updated>2014-03-13T09:34:02-04:00</updated>
    <id>http://bitjudo.com/blog/2014/03/13/building-efficient-dockerfiles-node-dot-js</id>
    <content type="html"><![CDATA[<h1>TL;DR</h1>

<p>Use the following code snippet (or a variation) after all your app dependencies
but before you ADD your app code to the container&hellip; this way you don&rsquo;t rebuild
your modules each time you re-build your container. If your <code>package.json</code> file
changes then your modules will be rebuilt.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Add this to your Dockerfile <a href="https://gist.github.com/dweinstein/9468644">https://gist.github.com/dweinstein/9468644</a> gist </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>ADD package.json /tmp/package.json
</span><span class='line'>RUN cd /tmp &amp;amp;&amp;amp; npm install
</span><span class='line'>RUN mkdir -p /opt/app &amp;amp;&amp;amp; cp -a /tmp/node_modules /opt/app/
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h1>Using cached layers for modules</h1>

<p>This article is about making efficient use of docker layers, and as a side
effect how to reduce development and debugging time for Node.js applications
hosted in Docker containers. As you migrate from developing everything on your
host system into Docker, there are some growing pains, mainly arround rapid
change and test workflows.</p>

<!-- more -->


<p>There was a time when each time I&rsquo;d make a slight modification to my
application, I&rsquo;d spend time waiting for my docker container to reubild, usually
waiting for the modules to be reinstalled.  I&rsquo;d spend more time waiting for the
dependencies to rebuild than actually fixing the problem.  I hope this article
helps others get out of that ditch&hellip;</p>

<p>Surround your pullquote like this {" text to be quoted "}</p>

<p>One key is to understand how Docker layers work. For now I&rsquo;ll direct you to the
<a href="http://docs.docker.io/en/latest/terms/layer/">documentation</a> to see the
graphic showing the various layers. Commands in your <code>Dockerfile</code> will create
new layers. When possible, docker will try to use an existing cached layer if
it&rsquo;s possible. You should try to take advantage of layers as much as possible
by organizing your commands in a specific order. We&rsquo;ll get into that order in a
second for dealing with node modules in your application.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Example &ndash; package.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">name</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">myApp</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">description</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">This</span> <span class="nx">is</span> <span class="nx">my</span> <span class="nx">awesome</span> <span class="nx">app</span><span class="o">&amp;</span><span class="nx">hellip</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">version</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="mf">0.0</span><span class="p">.</span><span class="mi">1</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="kr">private</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">scripts</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span><span class="o">:</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="s2">&quot;start&quot;</span><span class="o">:</span> <span class="s2">&quot;node server.js&quot;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="p">},</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">dependencies</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span><span class="o">:</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="s2">&quot;docker.io&quot;</span><span class="o">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span class='line'><span class="s2">&quot;redis&quot;</span><span class="o">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span class='line'><span class="s2">&quot;restify&quot;</span><span class="o">:</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This snippet should generally go after all dependencies for your application
have been installed, and just before you add your application&rsquo;s code to the
container.</p>

<p>So here&rsquo;s a full example:</p>

<p>```
FROM ubuntu
MAINTAINER David Weinstein <a href="&#109;&#x61;&#105;&#108;&#116;&#111;&#58;&#x64;&#x61;&#x76;&#x69;&#x64;&#64;&#98;&#x69;&#116;&#106;&#x75;&#100;&#x6f;&#x2e;&#99;&#x6f;&#x6d;">&#x64;&#x61;&#x76;&#105;&#x64;&#x40;&#x62;&#x69;&#x74;&#x6a;&#117;&#x64;&#x6f;&#46;&#99;&#x6f;&#x6d;</a></p>

<h1>install our dependencies and nodejs</h1>

<p>RUN echo &ldquo;deb <a href="http://archive.ubuntu.com/ubuntu">http://archive.ubuntu.com/ubuntu</a> precise main universe&rdquo; > /etc/apt/sources.list
RUN apt-get update
RUN apt-get -y install python-software-properties git build-essential
RUN add-apt-repository -y ppa:chris-lea/node.js
RUN apt-get update
RUN apt-get -y install nodejs</p>

<h1>use changes to package.json to force Docker not to use the cache</h1>

<h1>when we change our application&rsquo;s nodejs dependencies:</h1>

<p>ADD package.json /tmp/package.json
RUN cd /tmp &amp;&amp; npm install
RUN mkdir -p /opt/app &amp;&amp; cp -a /tmp/node_modules /opt/app/</p>

<h1>From here we load our application&rsquo;s code in, therefore the previous docker</h1>

<h1>&ldquo;layer&rdquo; thats been cached will be used if possible</h1>

<p>WORKDIR /opt/app
ADD . /opt/app</p>

<p>EXPOSE 3000</p>

<p>CMD [&ldquo;node&rdquo;, &ldquo;server.js&rdquo;]
```</p>

<p>The idea here is that if the <code>package.json</code> file changes (line 14) then Docker
will re-run the <code>npm install</code> sequence (line 15)&hellip; otherwise Docker will use
our cache and skip that part. This way our modules are cached so we aren&rsquo;t
rebuilding them every time we change our apps source code!</p>
]]></content>
  </entry>
  
</feed>
